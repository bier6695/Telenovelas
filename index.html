<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Helader√≠a POS - Firebase Real Time</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 2rem;
            font-weight: bold;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .online-indicator {
            width: 12px;
            height: 12px;
            background: #4ecdc4;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .offline-indicator {
            width: 12px;
            height: 12px;
            background: #e74c3c;
            border-radius: 50%;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(78, 205, 196, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(78, 205, 196, 0); }
            100% { box-shadow: 0 0 0 0 rgba(78, 205, 196, 0); }
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
        }

        .nav-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: transform 0.2s;
        }

        .nav-btn:hover {
            transform: translateY(-2px);
        }

        .nav-btn.active {
            background: linear-gradient(45deg, #4ecdc4, #45b7aa);
        }

        .main-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 25px;
            color: white;
            font-weight: bold;
            z-index: 1000;
            transition: all 0.3s;
        }

        .connected {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
        }

        .disconnected {
            background: linear-gradient(45deg, #fd79a8, #e84393);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .pos-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
        }

        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .product-card {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 50%, #fecfef 100%);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s;
            border: none;
            color: #333;
            position: relative;
        }

        .product-card:hover {
            transform: translateY(-5px);
        }

        .product-card.low-stock {
            background: linear-gradient(135deg, #ff6b6b 0%, #ffa8a8 100%);
            color: white;
        }

        .product-icon {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        .cart {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            min-height: 400px;
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .cart-total {
            font-size: 1.5rem;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
            color: #667eea;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.2s;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .btn-success {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(45deg, #ffeaa7, #fdcb6e);
            color: #333;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .table th {
            background: #f8f9fa;
            font-weight: bold;
        }

        .real-time-notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(78, 205, 196, 0.95);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            font-weight: bold;
            display: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 1000;
        }

        .payment-methods {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }

        .payment-method {
            flex: 1;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .payment-method.selected {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .quantity-btn {
            width: 30px;
            height: 30px;
            border: none;
            border-radius: 50%;
            background: #667eea;
            color: white;
            cursor: pointer;
            font-weight: bold;
        }

        .login-container {
            max-width: 400px;
            margin: 10% auto;
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .vendor-select {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .vendor-card {
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .vendor-card:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .vendor-card.selected {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .firebase-config {
            background: #2d3748;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            overflow-x: auto;
        }

        .config-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <!-- Configuraci√≥n Firebase -->
    <div id="configSection" class="section active">
        <div class="login-container">
            <div class="config-section">
                <h2>üîß Configuraci√≥n Firebase</h2>
                <p><strong>PASO 1:</strong> Copia tu configuraci√≥n Firebase aqu√≠:</p>
                
                <div class="firebase-config">
// REEMPLAZA ESTA CONFIGURACI√ìN CON LA TUYA:
const firebaseConfig = {
  apiKey: "AI25aSyD-WV5eeZ-OOpT8YFFWr9-O29Dq_hMyU6w",
  authDomain: "heladeria-pos.firebaseapp.com",
  databaseURL: "https://heladeria-pos-default-rtdb.firebaseio.com/",
  projectId: "heladeria-pos",
  storageBucket: "heladeria-pos.firebasestorage.app",
  messagingSenderId: "171441568131",
  appId: "1:171441568131:web:6f730a3e64b7973581Seb6"
};
                </div>

                <p><strong>PASO 2:</strong> Configura las reglas de la base de datos:</p>
                <ol>
                    <li>Ve a "Realtime Database" en tu consola Firebase</li>
                    <li>Clic en la pesta√±a "Reglas"</li>
                    <li>Reemplaza las reglas con este c√≥digo:</li>
                </ol>

                <div class="firebase-config">
{
  "rules": {
    ".read": true,
    ".write": true,
    "products": {
      ".indexOn": ["id", "name"]
    },
    "sales": {
      ".indexOn": ["date", "vendedor", "timestamp"]
    },
    "clients": {
      ".indexOn": ["name"]
    },
    "credits": {
      ".indexOn": ["cliente", "status", "date"]
    }
  }
}
                </div>

                <p><strong>‚ö†Ô∏è Importante:</strong> Estas reglas permiten acceso completo. Para producci√≥n, implementa autenticaci√≥n.</p>
                
                <button class="btn btn-success" onclick="initializeFirebase()" style="width: 100%; margin-top: 20px;">
                    üöÄ Inicializar Sistema POS
                </button>
            </div>
        </div>
    </div>

    <!-- Login de Vendedor -->
    <div id="loginSection" class="section">
        <div class="login-container">
            <h2 style="text-align: center; margin-bottom: 30px;">üç¶ Selecciona tu Usuario</h2>
            
            <div class="vendor-select" id="vendorSelect">
                <div class="vendor-card" data-vendor="Juan P√©rez">
                    <div style="font-size: 2rem;">üë®‚Äçüíº</div>
                    <strong>Juan P√©rez</strong>
                    <div>Administrador</div>
                </div>
                <div class="vendor-card" data-vendor="Mar√≠a Garc√≠a">
                    <div style="font-size: 2rem;">üë©‚Äçüíº</div>
                    <strong>Mar√≠a Garc√≠a</strong>
                    <div>Vendedora</div>
                </div>
                <div class="vendor-card" data-vendor="Carlos L√≥pez">
                    <div style="font-size: 2rem;">üë®‚Äçüíº</div>
                    <strong>Carlos L√≥pez</strong>
                    <div>Vendedor</div>
                </div>
            </div>
            
            <button class="btn btn-primary" onclick="loginVendor()" style="width: 100%;" disabled id="loginBtn">
                Iniciar Sesi√≥n
            </button>
        </div>
    </div>

    <!-- Sistema POS Principal -->
    <div id="mainSystem" class="section">
        <div class="connection-status connected" id="connectionStatus">
            üü¢ Conectado a Firebase
        </div>

        <div class="real-time-notification" id="realtimeNotification">
            üìä Datos actualizados en tiempo real
        </div>

        <div class="container">
            <div class="header">
                <div class="logo">üç¶ Helader√≠a POS - Multi Vendedor</div>
                <div class="nav-buttons">
                    <button class="nav-btn active" onclick="showSection('dashboard')">Dashboard</button>
                    <button class="nav-btn" onclick="showSection('pos')">Punto de Venta</button>
                    <button class="nav-btn" onclick="showSection('inventory')">Inventario</button>
                    <button class="nav-btn" onclick="showSection('credits')">Cr√©ditos</button>
                </div>
                <div class="user-info">
                    <span class="online-indicator" id="onlineIndicator"></span>
                    <span id="currentUser">Usuario</span>
                    <button class="btn btn-warning" onclick="logout()" style="padding: 8px 15px;">Salir</button>
                </div>
            </div>

            <div class="main-content">
                <!-- Dashboard -->
                <div id="dashboard" class="subsection active">
                    <h2>Dashboard - Tiempo Real</h2>
                    <div class="dashboard-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="totalSales">$0.00</div>
                            <div>Ventas del D√≠a</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="cashSales">$0.00</div>
                            <div>Ventas Efectivo</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="transferSales">$0.00</div>
                            <div>Transferencias</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="creditSales">$0.00</div>
                            <div>Ventas a Cr√©dito</div>
                        </div>
                    </div>

                    <div id="lowStockAlert" style="margin-bottom: 20px;"></div>

                    <h3>Ventas Recientes (Tiempo Real)</h3>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Hora</th>
                                <th>Vendedor</th>
                                <th>Cliente</th>
                                <th>Productos</th>
                                <th>Total</th>
                                <th>Pago</th>
                            </tr>
                        </thead>
                        <tbody id="recentSalesTable"></tbody>
                    </table>
                </div>

                <!-- Punto de Venta -->
                <div id="pos" class="subsection">
                    <h2>Punto de Venta</h2>
                    <div class="pos-grid">
                        <div>
                            <h3>Productos</h3>
                            <div class="products-grid" id="productsGrid"></div>
                        </div>

                        <div class="cart">
                            <h3>Carrito de Compras</h3>
                            <div id="cartItems"></div>
                            <div class="cart-total" id="cartTotal">Total: $0.00</div>

                            <div class="form-group">
                                <label>Cliente</label>
                                <select class="form-control" id="clienteSelect">
                                    <option value="">Cliente General</option>
                                </select>
                            </div>

                            <div class="payment-methods">
                                <div class="payment-method selected" data-method="efectivo">
                                    üíµ<br>Efectivo
                                </div>
                                <div class="payment-method" data-method="transferencia">
                                    üí≥<br>Transferencia
                                </div>
                                <div class="payment-method" data-method="credito">
                                    üìù<br>Cr√©dito
                                </div>
                            </div>

                            <button class="btn btn-success" style="width: 100%;" onclick="processSale()">
                                Procesar Venta
                            </button>
                            <button class="btn btn-warning" style="width: 100%; margin-top: 10px;" onclick="clearCart()">
                                Limpiar Carrito
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Inventario -->
                <div id="inventory" class="subsection">
                    <h2>Control de Inventario</h2>
                    <button class="btn btn-primary" onclick="showAddProductForm()">Agregar Producto</button>
                    
                    <div id="addProductForm" style="display: none; margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                        <h4>Nuevo Producto</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <input type="text" class="form-control" id="newProductName" placeholder="Nombre del producto">
                            <input type="number" step="0.01" class="form-control" id="newProductPrice" placeholder="Precio">
                            <input type="number" class="form-control" id="newProductStock" placeholder="Stock inicial">
                            <input type="number" class="form-control" id="newProductMinStock" placeholder="Stock m√≠nimo">
                        </div>
                        <div style="margin-top: 15px;">
                            <button class="btn btn-success" onclick="addProduct()">Agregar</button>
                            <button class="btn btn-warning" onclick="hideAddProductForm()">Cancelar</button>
                        </div>
                    </div>

                    <table class="table">
                        <thead>
                            <tr>
                                <th>Producto</th>
                                <th>Precio</th>
                                <th>Stock</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="inventoryTable"></tbody>
                    </table>
                </div>

                <!-- Cr√©ditos -->
                <div id="credits" class="subsection">
                    <h2>Gesti√≥n de Cr√©ditos</h2>
                    
                    <div class="dashboard-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="totalCredits">$0.00</div>
                            <div>Total en Cr√©ditos</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="clientsWithDebt">0</div>
                            <div>Clientes con Deuda</div>
                        </div>
                    </div>

                    <table class="table">
                        <thead>
                            <tr>
                                <th>Cliente</th>
                                <th>Deuda Total</th>
                                <th>√öltima Compra</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="creditsTable"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>

    <script>
        // Variables globales
        let app, database;
        let currentUser = '';
        let cart = [];
        let selectedPaymentMethod = 'efectivo';
        let products = {};
        let clients = {};
        let sales = {};
        let credits = {};

        // Configuraci√≥n Firebase (REEMPLAZA CON LA TUYA)
        const firebaseConfig = {
            apiKey: "AI25aSyD-WV5eeZ-OOpT8YFFWr9-O29Dq_hMyU6w",
            authDomain: "heladeria-pos.firebaseapp.com",
            databaseURL: "https://heladeria-pos-default-rtdb.firebaseio.com/",
            projectId: "heladeria-pos",
            storageBucket: "heladeria-pos.firebasestorage.app",
            messagingSenderId: "171441568131",
            appId: "1:171441568131:web:6f730a3e64b7973581Seb6"
        };

        // Funci√≥n para inicializar Firebase
        function initializeFirebase() {
            try {
                app = firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                
                // Inicializar datos de ejemplo si no existen
                initializeDefaultData();
                
                // Configurar listeners en tiempo real
                setupRealtimeListeners();
                
                // Mostrar pantalla de login
                showSection('loginSection');
                
                showNotification('üî• Firebase conectado exitosamente!');
            } catch (error) {
                alert('Error conectando Firebase: ' + error.message);
                console.error('Firebase error:', error);
            }
        }

        // Inicializar datos por defecto
        function initializeDefaultData() {
            // Productos iniciales
            const defaultProducts = {
                'H001': {id: 'H001', name: 'Vainilla', price: 3.00, stock: 50, minStock: 10, icon: 'üç¶'},
                'H002': {id: 'H002', name: 'Chocolate', price: 3.00, stock: 45, minStock: 10, icon: 'üç´'},
                'H003': {id: 'H003', name: 'Fresa', price: 3.50, stock: 30, minStock: 10, icon: 'üçì'},
                'H004': {id: 'H004', name: 'Cookies & Cream', price: 4.00, stock: 25, minStock: 10, icon: 'üç™'},
                'H005': {id: 'H005', name: 'Menta', price: 3.50, stock: 20, minStock: 10, icon: 'üåø'},
                'H006': {id: 'H006', name: 'Mango', price: 3.75, stock: 35, minStock: 10, icon: 'ü•≠'}
            };

            // Clientes iniciales
            const defaultClients = {
                'C001': {id: 'C001', name: 'Ana Mart√≠nez', phone: '809-111-2222'},
                'C002': {id: 'C002', name: 'Luis Rodr√≠guez', phone: '809-333-4444'},
                'C003': {id: 'C003', name: 'Carmen Soto', phone: '809-555-6666'}
            };

            // Solo crear si no existen
            database.ref('products').once('value', (snapshot) => {
                if (!snapshot.exists()) {
                    database.ref('products').set(defaultProducts);
                }
            });

            database.ref('clients').once('value', (snapshot) => {
                if (!snapshot.exists()) {
                    database.ref('clients').set(defaultClients);
                }
            });
        }

        // Configurar listeners en tiempo real
        function setupRealtimeListeners() {
            // Listener para productos
            database.ref('products').on('value', (snapshot) => {
                products = snapshot.val() || {};
                updateProductsDisplay();
                updateInventoryDisplay();
                updateDashboard();
                showNotification('üì¶ Inventario actualizado');
            });

            // Listener para clientes
            database.ref('clients').on('value', (snapshot) => {
                clients = snapshot.val() || {};
                updateClientsSelect();
            });

            // Listener para ventas
            database.ref('sales').on('value', (snapshot) => {
                sales = snapshot.val() || {};
                updateDashboard();
                updateRecentSales();
                showNotification('üí∞ Ventas actualizadas');
            });

            // Listener para cr√©ditos
            database.ref('credits').on('value', (snapshot) => {
                credits = snapshot.val() || {};
                updateCreditsDisplay();
                showNotification('üìù Cr√©ditos actualizados');
            });
        }

        // Selecci√≥n de vendedor
        document.addEventListener('DOMContentLoaded', function() {
            const vendorCards = document.querySelectorAll('.vendor-card');
            const loginBtn = document.getElementById('loginBtn');

            vendorCards.forEach(card => {
                card.addEventListener('click', function() {
                    vendorCards.forEach(c => c.classList.remove('selected'));
                    this.classList.add('selected');
                    loginBtn.disabled = false;
                    currentUser = this.dataset.vendor;
                });
            });
        });

        function loginVendor() {
            if (currentUser) {
                document.getElementById('currentUser').textContent = currentUser;
                showSection('mainSystem');
                showNotification(`üëã Bienvenido ${currentUser}!`);
            }
        }

        function logout() {
            currentUser = '';
            cart = [];
            showSection('loginSection');
        }

        // Navegaci√≥n entre secciones
        function showSection(sectionId) {
            // Ocultar todas las secciones principales
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Mostrar secci√≥n seleccionada
            document.getElementById(sectionId).classList.add('active');
            
            if (sectionId === 'mainSystem') {
                showSubSection('dashboard');
            }
        }

        function showSubSection(subSectionId) {
            // Remover clase active de botones
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Ocultar todas las subsecciones
            document.querySelectorAll('.subsection').forEach(section => {
                section.classList.remove('active');
            });
            
            // Mostrar subsecci√≥n seleccionada
            document.getElementById(subSectionId).classList.add('active');
            
            // Activar bot√≥n correspondiente
            event.target.classList.add('active');
        }

        // Actualizar display de productos
        function updateProductsDisplay() {
            const grid = document.getElementById('productsGrid');
            if (!grid) return;
            
            grid.innerHTML = '';
            
            Object.values(products).forEach(product => {
                const card = document.createElement('button');
                card.className = `product-card ${product.stock <= product.minStock ? 'low-stock' : ''}`;
                card.onclick = () => addToCart(product);
                
                card.innerHTML = `
                    <div class="product-icon">${product.icon}</div>
                    <div><strong>${product.name}</strong></div>
                    <div>${product.price.toFixed(2)}</div>
                    <div>Stock: ${product.stock}</div>
                `;
                
                grid.appendChild(card);
            });
        }

        // Actualizar display de inventario
        function updateInventoryDisplay() {
            const tbody = document.getElementById('inventoryTable');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            Object.values(products).forEach(product => {
                const row = document.createElement('tr');
                const status = product.stock <= product.minStock ? 
                    '<span style="color: #e74c3c;">‚ö†Ô∏è Stock Bajo</span>' : 
                    '<span style="color: #27ae60;">‚úÖ OK</span>';
                
                row.innerHTML = `
                    <td>${product.icon} ${product.name}</td>
                    <td>${product.price.toFixed(2)}</td>
                    <td>${product.stock}</td>
                    <td>${status}</td>
                    <td>
                        <button class="btn btn-primary" onclick="restockProduct('${product.id}')" style="padding: 5px 10px; margin-right: 5px;">üì¶ +Stock</button>
                        <button class="btn btn-warning" onclick="editProduct('${product.id}')" style="padding: 5px 10px;">‚úèÔ∏è Editar</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Actualizar selector de clientes
        function updateClientsSelect() {
            const select = document.getElementById('clienteSelect');
            if (!select) return;
            
            select.innerHTML = '<option value="">Cliente General</option>';
            Object.values(clients).forEach(client => {
                select.innerHTML += `<option value="${client.name}">${client.name}</option>`;
            });
        }

        // Funciones del carrito
        function addToCart(product) {
            if (product.stock <= 0) {
                alert('Producto sin stock disponible');
                return;
            }
            
            const existingItem = cart.find(item => item.id === product.id);
            
            if (existingItem) {
                if (existingItem.quantity < product.stock) {
                    existingItem.quantity++;
                } else {
                    alert('No hay suficiente stock disponible');
                    return;
                }
            } else {
                cart.push({
                    id: product.id,
                    name: product.name,
                    price: product.price,
                    quantity: 1,
                    maxStock: product.stock
                });
            }
            
            renderCart();
        }

        function renderCart() {
            const cartItems = document.getElementById('cartItems');
            const cartTotal = document.getElementById('cartTotal');
            if (!cartItems || !cartTotal) return;
            
            cartItems.innerHTML = '';
            let total = 0;
            
            cart.forEach((item, index) => {
                const cartItem = document.createElement('div');
                cartItem.className = 'cart-item';
                cartItem.innerHTML = `
                    <div>
                        <strong>${item.name}</strong><br>
                        ${item.price.toFixed(2)} c/u
                    </div>
                    <div class="quantity-controls">
                        <button class="quantity-btn" onclick="changeQuantity(${index}, -1)">-</button>
                        <span>${item.quantity}</span>
                        <button class="quantity-btn" onclick="changeQuantity(${index}, 1)">+</button>
                        <button onclick="removeFromCart(${index})" style="margin-left: 10px; background: #e74c3c; color: white; border: none; padding: 5px 8px; border-radius: 5px; cursor: pointer;">üóëÔ∏è</button>
                    </div>
                `;
                
                cartItems.appendChild(cartItem);
                total += item.price * item.quantity;
            });
            
            cartTotal.textContent = `Total: ${total.toFixed(2)}`;
        }

        function changeQuantity(index, change) {
            const item = cart[index];
            const newQuantity = item.quantity + change;
            
            if (newQuantity <= 0) {
                removeFromCart(index);
                return;
            }
            
            if (newQuantity > item.maxStock) {
                alert('No hay suficiente stock disponible');
                return;
            }
            
            item.quantity = newQuantity;
            renderCart();
        }

        function removeFromCart(index) {
            cart.splice(index, 1);
            renderCart();
        }

        function clearCart() {
            cart = [];
            renderCart();
        }

        // Selecci√≥n de m√©todo de pago
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.payment-method').forEach(method => {
                method.addEventListener('click', function() {
                    document.querySelectorAll('.payment-method').forEach(m => m.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedPaymentMethod = this.dataset.method;
                });
            });
        });

        // Procesar venta
        function processSale() {
            if (cart.length === 0) {
                alert('El carrito est√° vac√≠o');
                return;
            }
            
            const cliente = document.getElementById('clienteSelect').value || 'Cliente General';
            
            if (selectedPaymentMethod === 'credito' && cliente === 'Cliente General') {
                alert('Debe seleccionar un cliente para ventas a cr√©dito');
                return;
            }
            
            let total = 0;
            cart.forEach(item => {
                total += item.price * item.quantity;
            });
            
            const saleId = 'S' + Date.now();
            const saleData = {
                id: saleId,
                date: new Date().toISOString().split('T')[0],
                time: new Date().toLocaleTimeString(),
                vendedor: currentUser,
                cliente: cliente,
                items: [...cart],
                total: total,
                paymentMethod: selectedPaymentMethod,
                timestamp: Date.now()
            };
            
            // Guardar venta en Firebase
            database.ref('sales/' + saleId).set(saleData);
            
            // Si es cr√©dito, agregar a cr√©ditos
            if (selectedPaymentMethod === 'credito') {
                const creditId = 'C' + Date.now();
                const creditData = {
                    id: creditId,
                    saleId: saleId,
                    date: saleData.date,
                    cliente: cliente,
                    vendedor: currentUser,
                    items: [...cart],
                    total: total,
                    status: 'PENDIENTE'
                };
                database.ref('credits/' + creditId).set(creditData);
            }
            
            // Actualizar stock en Firebase
            cart.forEach(item => {
                const newStock = products[item.id].stock - item.quantity;
                database.ref('products/' + item.id + '/stock').set(newStock);
            });
            
            // Limpiar carrito
            clearCart();
            
            alert(`¬°Venta procesada exitosamente!\nTotal: ${total.toFixed(2)}\nM√©todo: ${selectedPaymentMethod.charAt(0).toUpperCase() + selectedPaymentMethod.slice(1)}`);
        }

        // Actualizar dashboard
        function updateDashboard() {
            const today = new Date().toISOString().split('T')[0];
            const todaySales = Object.values(sales).filter(sale => sale.date === today);
            
            let totalSales = 0;
            let cashSales = 0;
            let transferSales = 0;
            let creditSales = 0;
            
            todaySales.forEach(sale => {
                totalSales += sale.total;
                if (sale.paymentMethod === 'efectivo') cashSales += sale.total;
                else if (sale.paymentMethod === 'transferencia') transferSales += sale.total;
                else if (sale.paymentMethod === 'credito') creditSales += sale.total;
            });
            
            const totalSalesEl = document.getElementById('totalSales');
            const cashSalesEl = document.getElementById('cashSales');
            const transferSalesEl = document.getElementById('transferSales');
            const creditSalesEl = document.getElementById('creditSales');
            
            if (totalSalesEl) totalSalesEl.textContent = `${totalSales.toFixed(2)}`;
            if (cashSalesEl) cashSalesEl.textContent = `${cashSales.toFixed(2)}`;
            if (transferSalesEl) transferSalesEl.textContent = `${transferSales.toFixed(2)}`;
            if (creditSalesEl) creditSalesEl.textContent = `${creditSales.toFixed(2)}`;
            
            // Alertas de stock bajo
            updateLowStockAlert();
        }

        function updateLowStockAlert() {
            const alertDiv = document.getElementById('lowStockAlert');
            if (!alertDiv) return;
            
            const lowStockProducts = Object.values(products).filter(p => p.stock <= p.minStock);
            
            if (lowStockProducts.length > 0) {
                alertDiv.innerHTML = `
                    <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 10px; color: #856404;">
                        <strong>‚ö†Ô∏è Productos con stock bajo:</strong><br>
                        ${lowStockProducts.map(p => `${p.name} (${p.stock} unidades)`).join(', ')}
                    </div>
                `;
            } else {
                alertDiv.innerHTML = `
                    <div style="background: #d4edda; border: 1px solid #c3e6cb; padding: 15px; border-radius: 10px; color: #155724;">
                        ‚úÖ Todos los productos tienen stock suficiente
                    </div>
                `;
            }
        }

        function updateRecentSales() {
            const tbody = document.getElementById('recentSalesTable');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            const today = new Date().toISOString().split('T')[0];
            const todaySales = Object.values(sales)
                .filter(sale => sale.date === today)
                .sort((a, b) => b.timestamp - a.timestamp)
                .slice(0, 10);
            
            todaySales.forEach(sale => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${sale.time}</td>
                    <td>${sale.vendedor}</td>
                    <td>${sale.cliente}</td>
                    <td>${sale.items.map(item => `${item.name} (${item.quantity})`).join(', ')}</td>
                    <td>${sale.total.toFixed(2)}</td>
                    <td>${sale.paymentMethod.charAt(0).toUpperCase() + sale.paymentMethod.slice(1)}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateCreditsDisplay() {
            const totalCreditsEl = document.getElementById('totalCredits');
            const clientsWithDebtEl = document.getElementById('clientsWithDebt');
            const creditsTableBody = document.getElementById('creditsTable');
            
            if (!creditsTableBody) return;
            
            const pendingCredits = Object.values(credits).filter(c => c.status === 'PENDIENTE');
            const totalCredits = pendingCredits.reduce((sum, credit) => sum + credit.total, 0);
            const uniqueClients = new Set(pendingCredits.map(c => c.cliente)).size;
            
            if (totalCreditsEl) totalCreditsEl.textContent = `${totalCredits.toFixed(2)}`;
            if (clientsWithDebtEl) clientsWithDebtEl.textContent = uniqueClients;
            
            // Agrupar cr√©ditos por cliente
            const clientDebts = {};
            pendingCredits.forEach(credit => {
                if (!clientDebts[credit.cliente]) {
                    clientDebts[credit.cliente] = {
                        total: 0,
                        lastPurchase: credit.date
                    };
                }
                clientDebts[credit.cliente].total += credit.total;
                if (credit.date > clientDebts[credit.cliente].lastPurchase) {
                    clientDebts[credit.cliente].lastPurchase = credit.date;
                }
            });
            
            creditsTableBody.innerHTML = '';
            Object.keys(clientDebts).forEach(client => {
                const debt = clientDebts[client];
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${client}</td>
                    <td>${debt.total.toFixed(2)}</td>
                    <td>${debt.lastPurchase}</td>
                    <td>
                        <button class="btn btn-success" onclick="processPayment('${client}')" style="padding: 5px 10px;">üí∞ Registrar Pago</button>
                    </td>
                `;
                creditsTableBody.appendChild(row);
            });
        }

        // Funciones de inventario
        function showAddProductForm() {
            document.getElementById('addProductForm').style.display = 'block';
        }

        function hideAddProductForm() {
            document.getElementById('addProductForm').style.display = 'none';
            // Limpiar campos
            document.getElementById('newProductName').value = '';
            document.getElementById('newProductPrice').value = '';
            document.getElementById('newProductStock').value = '';
            document.getElementById('newProductMinStock').value = '';
        }

        function addProduct() {
            const name = document.getElementById('newProductName').value.trim();
            const price = parseFloat(document.getElementById('newProductPrice').value);
            const stock = parseInt(document.getElementById('newProductStock').value);
            const minStock = parseInt(document.getElementById('newProductMinStock').value);
            
            if (!name || !price || !stock || !minStock) {
                alert('Por favor complete todos los campos');
                return;
            }
            
            const productId = 'H' + Date.now();
            const icons = ['üç¶', 'üçß', 'üç®', 'üßÅ', 'üç∞', 'üéÇ', 'üç´', 'üçØ'];
            const randomIcon = icons[Math.floor(Math.random() * icons.length)];
            
            const productData = {
                id: productId,
                name: name,
                price: price,
                stock: stock,
                minStock: minStock,
                icon: randomIcon
            };
            
            database.ref('products/' + productId).set(productData);
            hideAddProductForm();
            showNotification(`‚úÖ Producto "${name}" agregado exitosamente!`);
        }

        function restockProduct(productId) {
            const quantity = prompt('¬øCu√°ntas unidades desea agregar al stock?');
            if (!quantity || isNaN(quantity) || quantity <= 0) return;
            
            const newStock = products[productId].stock + parseInt(quantity);
            database.ref('products/' + productId + '/stock').set(newStock);
            
            showNotification(`üì¶ Stock actualizado para ${products[productId].name}`);
        }

        function editProduct(productId) {
            const product = products[productId];
            const newPrice = prompt(`Nuevo precio para ${product.name}:`, product.price);
            const newMinStock = prompt(`Nuevo stock m√≠nimo para ${product.name}:`, product.minStock);
            
            const updates = {};
            if (newPrice && !isNaN(newPrice)) {
                updates[`products/${productId}/price`] = parseFloat(newPrice);
            }
            if (newMinStock && !isNaN(newMinStock)) {
                updates[`products/${productId}/minStock`] = parseInt(newMinStock);
            }
            
            if (Object.keys(updates).length > 0) {
                database.ref().update(updates);
                showNotification(`‚úÖ Producto ${product.name} actualizado!`);
            }
        }

        function processPayment(clientName) {
            const amount = prompt(`¬øCu√°nto pag√≥ ${clientName}?`);
            if (!amount || isNaN(amount) || amount <= 0) return;
            
            const paymentId = 'P' + Date.now();
            const paymentData = {
                id: paymentId,
                date: new Date().toISOString().split('T')[0],
                time: new Date().toLocaleTimeString(),
                cliente: clientName,
                amount: parseFloat(amount),
                vendedor: currentUser
            };
            
            database.ref('payments/' + paymentId).set(paymentData);
            
            // Marcar cr√©ditos como pagados si el monto cubre la deuda
            const clientCredits = Object.values(credits).filter(c => c.cliente === clientName && c.status === 'PENDIENTE');
            let remainingPayment = parseFloat(amount);
            
            clientCredits.forEach(credit => {
                if (remainingPayment >= credit.total) {
                    database.ref('credits/' + credit.id + '/status').set('PAGADO');
                    remainingPayment -= credit.total;
                }
            });
            
            showNotification(`üí∞ Pago de ${amount} registrado para ${clientName}`);
        }

        // Funci√≥n para mostrar notificaciones
        function showNotification(message) {
            const notification = document.getElementById('realtimeNotification');
            if (notification) {
                notification.textContent = message;
                notification.style.display = 'block';
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 3000);
            }
        }

        // Navegaci√≥n inicial
        window.addEventListener('DOMContentLoaded', function() {
            showSection('configSection');
        });
    </script>
</body>
</html>
